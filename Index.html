<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
    body { background: #0f172a; color: #f1f5f9; font-size: 0.85rem; padding: 15px; padding-bottom: 100px; font-family: 'Segoe UI', sans-serif; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
    @media (max-width: 850px) { .dashboard-grid { grid-template-columns: 1fr; } }
    
    .section-title { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; display: flex; justify-content: space-between; }
    .group-header { background: #1e293b; color: #60a5fa; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin: 15px 0 8px; border-left: 3px solid #60a5fa; }
    
    /* TDC Mini */
    .card-tdc-mini { background: #1e293b; border-radius: 6px; padding: 6px 12px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid; border: 1px solid #334155; }
    
    /* Santander y Cards */
    .card-santander { background: #1e293b; border: 1px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .card-flujo { background: #1e293b; border-radius: 10px; padding: 12px; margin-bottom: 8px; border: 1px solid #334155; }
    .card-fijo { background: #1e293b; padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; }
    
    .progress { height: 5px; background: #334155; margin-top: 8px; }
    .btn-float-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
    .btn-float { width: 55px; height: 55px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 2000; display: flex; justify-content: center; align-items: center; }
    .text-xs { font-size: 0.65rem; }
  </style>
</head>
<body>
  <div id="loader" class="loading-overlay"><div class="spinner-border text-info"></div></div>

  <div class="container-fluid">
    <div class="text-center mb-4 mt-2">
      <h3 id="titulo-qna" class="fw-bold text-info mb-0">--</h3>
      <div class="text-xs text-muted">Sinc: <span id="timestamp">--:--</span></div>
    </div>

    <div class="dashboard-grid">
      <div>
        <div id="tarjetas-area"></div>
        <div class="section-title mt-4"><span>‚öñÔ∏è Disponibilidad (Gastos)</span></div>
        <div id="flujo-area"></div>
      </div>
      <div>
        <div class="section-title"><span>üìã Monitor de Apartados</span> <span id="total-deuda" class="text-danger fw-bold"></span></div>
        <div id="santander-root"></div>
        <div id="fijos-area"></div>
      </div>
    </div>
  </div>

  <div class="btn-float-container">
    <button class="btn-float shadow" style="background:#10b981" data-bs-toggle="modal" data-bs-target="#modalSaldo">+</button>
    <button class="btn-float shadow" style="background:#ef4444" data-bs-toggle="modal" data-bs-target="#modalGasto">‚àí</button>
  </div>

  <div class="modal fade" id="modalGasto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">üìâ Registrar Gasto</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="text-xs">Rubro</label><select id="g-rubro" class="form-select form-select-sm"></select></div>
        <div class="mb-2"><label class="text-xs">Tarjeta</label><select id="g-tarjeta" class="form-select form-select-sm"></select></div>
        <div class="mb-2"><label class="text-xs">Monto ($)</label><input type="number" id="g-monto" class="form-control form-control-sm"></div>
        <div class="mb-0"><label class="text-xs">Nota</label><input type="text" id="g-desc" class="form-control form-control-sm"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-danger btn-sm w-100" onclick="ejecutarGasto(this)">GUARDAR</button></div>
    </div></div>
  </div>

  <div class="modal fade" id="modalSaldo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">üí∞ Actualizar Saldo</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="text-xs">Tarjeta</label><select id="s-tarjeta" class="form-select form-select-sm" onchange="filtrarCats()"></select></div>
        <div class="mb-2"><label class="text-xs">Categor√≠a</label><select id="s-categoria" class="form-select form-select-sm"></select></div>
        <div class="mb-0"><label class="text-xs">Monto Actual ($)</label><input type="number" id="s-monto" class="form-control form-control-sm"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-success btn-sm w-100" onclick="ejecutarSaldo(this)">ACTUALIZAR</button></div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let saldosReales = [];
    window.onload = () => refreshData();
    function refreshData() { document.getElementById('loader').style.display = 'flex'; google.script.run.withSuccessHandler(draw).getData(); }

    function draw(data) {
      if(!data || data.error) { alert("Error de datos"); return; }
      document.getElementById('timestamp').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.getElementById('loader').style.display = 'none';
      document.getElementById('titulo-qna').innerText = data.resumen.qna;
      document.getElementById('total-deuda').innerText = "Faltante Santander: $" + data.resumen.debesApartar;
      
      let tHtml = '<div class="section-title"><span>üí≥ Vencimientos TDC</span></div>';
      data.tarjetasStatus.forEach(t => {
        if(t.tocaPagar) {
          tHtml += `<div class="card-tdc-mini" style="border-left-color: var(--bs-${t.color})">
            <div><span class="fw-bold">${t.nombre}</span><span class="text-xs text-muted ms-2">D√≠a ${t.vence}</span></div>
            <div class="fw-bold text-${t.color}">${t.diasFaltan === 0 ? 'HOY' : t.diasFaltan + 'd'}</div>
          </div>`;
        }
      });
      document.getElementById('tarjetas-area').innerHTML = tHtml;

      const s = data.santander;
      document.getElementById('santander-root').innerHTML = `
        <div class="card-santander" style="${s.enviado ? 'opacity:0.5' : ''}">
          <div><div class="fw-bold text-info">SANTANDER TOTAL</div><div class="text-xs text-muted">Paquete suscripciones</div></div>
          <button class="btn btn-sm ${s.enviado ? 'btn-success' : 'btn-danger'}" onclick="confirmarSantander(${s.monto})" ${s.enviado ? 'disabled' : ''}>
            ${s.enviado ? 'ENVIADO ‚úÖ' : 'ENVIAR $' + s.monto}
          </button>
        </div>`;

      document.getElementById('flujo-area').innerHTML = renderizar(data.flujoAgrupados, true);
      document.getElementById('fijos-area').innerHTML = renderizar(data.fijosAgrupados, false);

      llenarSelect('g-rubro', data.config.rubros);
      llenarSelect('g-tarjeta', data.config.tarjetas);
      saldosReales = data.config.opcionesSaldos;
      llenarSelect('s-tarjeta', [...new Set(saldosReales.map(x => x.tarjeta))].sort());
      filtrarCats();
    }

    function renderizar(grupos, esFlujo) {
      let html = "";
      const hoy = new Date().getDate();
      grupos.forEach(grupo => {
        html += `<div class="group-header">${grupo.nombreTarjeta}</div>`;
        grupo.items.forEach(item => {
          if(esFlujo) {
            let pct = item.meta > 0 ? (item.actual / item.meta) * 100 : 100;
            let color = pct >= 100 ? 'success' : (pct > 0 ? 'warning' : 'danger');
            html += `<div class="card-flujo"><div class="d-flex justify-content-between"><div><span class="text-xs text-muted">${item.categoria}</span><br><span class="fw-bold">${item.nombre}</span></div><div class="text-end"><span class="fw-bold ${color==='success'?'text-success':''}">$${item.actual}</span><br><span class="text-xs text-muted">Presupuesto: $${item.meta}</span></div></div><div class="progress"><div class="progress-bar bg-${color}" style="width: ${Math.min(pct,100)}%"></div></div></div>`;
          } else {
            const dia = item.diaPago;
            let tocaPagar = (hoy <= 15 && dia >= hoy && dia <= 15) || (hoy > 15 && (dia >= hoy || dia <= 5));
            html += `<div class="card-fijo" style="${tocaPagar ? 'border-left: 4px solid #f59e0b; background:#1e293b' : ''}">
              <div><div class="fw-bold">${item.nombre} ${tocaPagar ? '‚ö†Ô∏è' : ''}</div><div class="text-xs text-info fw-bold">Guardado: $${item.actual}</div></div>
              <div class="text-end"><div class="text-xs text-muted">D√≠a ${dia}</div><span class="badge ${tocaPagar?'bg-warning text-dark':'bg-secondary'} text-xs">${tocaPagar?'TOCA PAGAR':'Pr√≥ximo'}</span></div>
            </div>`;
          }
        });
      });
      return html;
    }

    function confirmarSantander(m) { if(confirm(`¬øConfirmar env√≠o de $${m}?`)) { google.script.run.withSuccessHandler(()=>refreshData()).registrarPaqueteSantander(m); } }
    function ejecutarGasto(btn) { 
      const d = { rubro: document.getElementById('g-rubro').value, tarjeta: document.getElementById('g-tarjeta').value, monto: document.getElementById('g-monto').value, descripcion: document.getElementById('g-desc').value };
      if(!d.monto) return; btn.disabled=true; google.script.run.withSuccessHandler(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalGasto')).hide(); btn.disabled=false; refreshData(); }).registrarGasto(d); 
    }
    function ejecutarSaldo(btn) {
      const d = { tarjeta: document.getElementById('s-tarjeta').value, categoria: document.getElementById('s-categoria').value, nuevoSaldo: document.getElementById('s-monto').value };
      if(!d.nuevoSaldo) return; btn.disabled=true; google.script.run.withSuccessHandler(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalSaldo')).hide(); btn.disabled=false; refreshData(); }).actualizarSaldoDirecto(d);
    }
    function llenarSelect(id, lista) { document.getElementById(id).innerHTML = lista.map(i => `<option value="${i}">${i}</option>`).join(''); }
    function filtrarCats() { const t = document.getElementById('s-tarjeta').value; llenarSelect('s-categoria', saldosReales.filter(s => s.tarjeta === t).map(s => s.categoria)); }
  </script>
</body>
</html>